// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

model DailyReport {
  id              String         @id @default(uuid())
  reportDate      DateTime       @unique @map("report_date") @db.Date
  status          ReportStatus   @default(DRAFT)
  title           String?
  summary         String?
  generatedAt     DateTime       @map("generated_at")
  publishedAt     DateTime?      @map("published_at")
  sourceTimezone  String         @map("source_timezone")
  llmModel        String?        @map("llm_model")
  llmCostCents    Int?           @map("llm_cost_cents")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  stories         ReportStory[]

  @@map("daily_reports")
}

// Hourly Pulse - Top posts from r/all with top comments
model HourlyPulseReport {
  id              String             @id @default(uuid())
  reportHour      DateTime           @unique @map("report_hour")
  status          ReportStatus       @default(DRAFT)
  title           String?
  generatedAt     DateTime           @map("generated_at")
  publishedAt     DateTime?          @map("published_at")
  llmModel        String?            @map("llm_model")
  llmCostCents    Int?               @map("llm_cost_cents")
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")

  stories         HourlyPulseStory[]

  @@map("hourly_pulse_reports")
}

model HourlyPulseStory {
  id              String             @id @default(uuid())
  reportId        String             @map("report_id")
  rank            Int
  
  // Reddit Source Fields
  subreddit       String
  redditPostId    String             @map("reddit_post_id")
  redditPermalink String             @map("reddit_permalink")
  title           String
  postUrl         String?            @map("post_url")
  imageUrl        String?            @map("image_url")
  author          String?
  score           Int                @default(0)
  numComments     Int                @default(0) @map("num_comments")
  createdUtc      DateTime?          @map("created_utc")
  
  // LLM Outputs
  summary         String?
  sentimentLabel  String?            @map("sentiment_label")
  topicTags       Json?              @map("topic_tags")
  
  // Top comment
  topCommentAuthor  String?          @map("top_comment_author")
  topCommentBody    String?          @map("top_comment_body")
  topCommentScore   Int?             @map("top_comment_score")
  
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")

  report          HourlyPulseReport  @relation(fields: [reportId], references: [id])

  @@unique([reportId, rank])
  @@unique([reportId, redditPostId])
  @@index([reportId, rank])
  @@index([subreddit])
  @@index([redditPostId])
  @@map("hourly_pulse_stories")
}

// Hourly Discover - Random posts from popular subreddits
model HourlyReport {
  id              String         @id @default(uuid())
  reportHour      DateTime       @unique @map("report_hour") // Truncated to hour
  status          ReportStatus   @default(DRAFT)
  title           String?
  generatedAt     DateTime       @map("generated_at")
  publishedAt     DateTime?      @map("published_at")
  sourceSubreddits Json?         @map("source_subreddits") // Array of subreddit names used
  llmModel        String?        @map("llm_model")
  llmCostCents    Int?           @map("llm_cost_cents")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  stories         HourlyStory[]

  @@map("hourly_reports")
}

model HourlyStory {
  id              String         @id @default(uuid())
  reportId        String         @map("report_id")
  rank            Int
  
  // Reddit Source Fields
  subreddit       String
  redditPostId    String         @map("reddit_post_id")
  redditPermalink String         @map("reddit_permalink")
  title           String
  postUrl         String?        @map("post_url")
  imageUrl        String?        @map("image_url")
  author          String?
  score           Int            @default(0)
  numComments     Int            @default(0) @map("num_comments")
  createdUtc      DateTime?      @map("created_utc")
  
  // LLM Outputs (lighter than daily)
  summary         String?
  sentimentLabel  String?        @map("sentiment_label")
  topicTags       Json?          @map("topic_tags")
  
  // Top comment
  topCommentAuthor  String?      @map("top_comment_author")
  topCommentBody    String?      @map("top_comment_body")
  topCommentScore   Int?         @map("top_comment_score")
  
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  report          HourlyReport   @relation(fields: [reportId], references: [id])

  @@unique([reportId, rank])
  @@unique([reportId, redditPostId])
  @@index([reportId, rank])
  @@index([subreddit])
  @@index([redditPostId])
  @@map("hourly_stories")
}

enum ReportStatus {
  DRAFT
  PUBLISHED
  FAILED
}

model ReportStory {
  id              String         @id @default(uuid())
  reportId        String         @map("report_id")
  rank            Int
  
  // Reddit Source Fields
  subreddit       String
  redditPostId    String         @map("reddit_post_id")
  redditPermalink String         @map("reddit_permalink")
  title           String
  postUrl         String?        @map("post_url")
  imageUrl        String?        @map("image_url")
  author          String?
  score           Int            @default(0)
  numComments     Int            @default(0) @map("num_comments")
  createdUtc      DateTime?      @map("created_utc")
  
  // Metadata
  selectionScore  Decimal        @default(0) @map("selection_score")
  
  // LLM Outputs
  summary         String?
  sentimentLabel  String?        @map("sentiment_label") // Can be enum if strictly limited
  takeaways       Json?
  topicTags       Json?          @map("topic_tags")
  
  // Moderation
  contentWarning  String?        @map("content_warning")
  isHidden        Boolean        @default(false) @map("is_hidden")
  
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  report          DailyReport    @relation(fields: [reportId], references: [id])
  comments        StoryComment[]
  engagementEvents EngagementEvent[]

  @@unique([reportId, rank])
  @@unique([subreddit, redditPostId])
  @@index([reportId, rank])
  @@index([subreddit])
  @@index([redditPostId])
  @@map("report_stories")
}

model StoryComment {
  id              String         @id @default(uuid())
  storyId         String         @map("story_id")
  redditCommentId String         @map("reddit_comment_id")
  redditPermalink String         @map("reddit_permalink")
  author          String?
  body            String
  score           Int            @default(0)
  createdUtc      DateTime?      @map("created_utc")
  
  // Sampling Metadata
  sampleBucket    SampleBucket   @map("sample_bucket")
  positionInBucket Int           @map("position_in_bucket")
  
  // Display Metadata
  isHighlighted   Boolean        @default(false) @map("is_highlighted")
  highlightReason String?        @map("highlight_reason")
  
  createdAt       DateTime       @default(now()) @map("created_at")

  story           ReportStory    @relation(fields: [storyId], references: [id])

  @@unique([storyId, redditCommentId])
  @@index([storyId])
  @@index([isHighlighted])
  @@map("story_comments")
}

enum SampleBucket {
  TOP
  CONTROVERSIAL
  NEW
}

model Subscription {
  id              String         @id @default(uuid())
  email           String         @unique
  status          SubStatus      @default(PENDING)
  topics          Json?
  source          String
  referrer        String?
  createdAt       DateTime       @default(now()) @map("created_at")
  confirmedAt     DateTime?      @map("confirmed_at")
  unsubscribedAt  DateTime?      @map("unsubscribed_at")

  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("subscriptions")
}

enum SubStatus {
  PENDING
  ACTIVE
  UNSUBSCRIBED
  BOUNCED
}

model EngagementEvent {
  id              String         @id @default(uuid())
  anonymousId     String         @map("anonymous_id")
  eventType       EventType      @map("event_type")
  reportId        String?        @map("report_id")
  storyId         String?        @map("story_id")
  metadata        Json?
  ipHash          String?        @map("ip_hash")
  userAgentHash   String?        @map("user_agent_hash")
  createdAt       DateTime       @default(now()) @map("created_at")

  story           ReportStory?   @relation(fields: [storyId], references: [id])

  @@index([createdAt(sort: Desc)])
  @@index([eventType, createdAt(sort: Desc)])
  @@index([reportId])
  @@index([storyId])
  @@index([anonymousId, createdAt(sort: Desc)])
  @@map("engagement_events")
}

enum EventType {
  REACT_INTERESTING
  SAVE
  FOLLOW_TOPIC
  SUBSCRIBE_CLICK
  STORY_CLICK
}

// ============ Category-Based Discovery (Pro Feature) ============

model Category {
  id          String      @id @default(uuid())
  slug        String      @unique
  name        String
  description String?
  isActive    Boolean     @default(true) @map("is_active")
  sortOrder   Int         @default(0) @map("sort_order")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  subreddits  Subreddit[]
  userSelections UserCategorySelection[]

  @@map("categories")
}

model Subreddit {
  id          String    @id @default(uuid())
  name        String    @unique  // Without r/ prefix, e.g. "programming"
  categoryId  String    @map("category_id")
  isDefault   Boolean   @default(true) @map("is_default")  // Included by default when category selected
  sortOrder   Int       @default(0) @map("sort_order")
  createdAt   DateTime  @default(now()) @map("created_at")

  category    Category  @relation(fields: [categoryId], references: [id])
  userToggles UserSubredditToggle[]

  @@index([categoryId])
  @@map("subreddits")
}

model UserCategorySelection {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")  // Reddit username or anonymous ID
  categoryId  String    @map("category_id")
  createdAt   DateTime  @default(now()) @map("created_at")

  category    Category  @relation(fields: [categoryId], references: [id])

  @@unique([userId, categoryId])
  @@index([userId])
  @@map("user_category_selections")
}

model UserSubredditToggle {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  subredditId String    @map("subreddit_id")
  enabled     Boolean   @default(true)  // false = user disabled this subreddit
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  subreddit   Subreddit @relation(fields: [subredditId], references: [id])

  @@unique([userId, subredditId])
  @@index([userId])
  @@map("user_subreddit_toggles")
}

// User's generated discover reports
model DiscoverReport {
  id              String          @id @default(uuid())
  userId          String          @map("user_id")
  status          ReportStatus    @default(DRAFT)
  title           String?
  generatedAt     DateTime        @map("generated_at")
  publishedAt     DateTime?       @map("published_at")
  sourceCategories Json?          @map("source_categories")  // Snapshot of categories used
  sourceSubreddits Json?          @map("source_subreddits")  // Snapshot of subreddits used
  llmModel        String?         @map("llm_model")
  llmCostCents    Int?            @map("llm_cost_cents")
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  stories         DiscoverStory[]

  @@index([userId])
  @@index([userId, createdAt(sort: Desc)])
  @@map("discover_reports")
}

model DiscoverStory {
  id              String          @id @default(uuid())
  reportId        String          @map("report_id")
  rank            Int
  
  // Reddit Source Fields
  subreddit       String
  redditPostId    String          @map("reddit_post_id")
  redditPermalink String          @map("reddit_permalink")
  title           String
  postUrl         String?         @map("post_url")
  imageUrl        String?         @map("image_url")
  author          String?
  score           Int             @default(0)
  numComments     Int             @default(0) @map("num_comments")
  createdUtc      DateTime?       @map("created_utc")
  isSelfPost      Boolean         @default(false) @map("is_self_post")
  
  // LLM Outputs
  summary         String?
  sentimentLabel  String?         @map("sentiment_label")
  topicTags       Json?           @map("topic_tags")
  
  // Top comment
  topCommentAuthor  String?       @map("top_comment_author")
  topCommentBody    String?       @map("top_comment_body")
  topCommentScore   Int?          @map("top_comment_score")
  
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  report          DiscoverReport  @relation(fields: [reportId], references: [id])

  @@unique([reportId, rank])
  @@unique([reportId, redditPostId])
  @@index([reportId, rank])
  @@index([subreddit])
  @@index([redditPostId])
  @@map("discover_stories")
}

// ============ User & Subscription Management ============

model User {
  id              String    @id @default(uuid())
  redditId        String?   @unique @map("reddit_id")
  redditUsername  String    @unique @map("reddit_username")
  email           String?
  isPro           Boolean   @default(false) @map("is_pro")
  proExpiresAt    DateTime? @map("pro_expires_at")
  stripeCustomerId String?  @map("stripe_customer_id")
  isAdmin         Boolean   @default(false) @map("is_admin")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@index([redditUsername])
  @@index([stripeCustomerId])
  @@map("users")
}

// ============ Global Briefing (Free Tier Content) ============

model GlobalBriefing {
  id              String              @id @default(uuid())
  periodStart     DateTime            @unique @map("period_start")  // 6-hour windows: 0, 6, 12, 18 UTC
  status          ReportStatus        @default(DRAFT)
  title           String?
  executiveSummary String?            @map("executive_summary")  // Premium AI narrative
  generatedAt     DateTime            @map("generated_at")
  publishedAt     DateTime?           @map("published_at")
  llmModel        String?             @map("llm_model")  // "gpt-5.2"
  llmCostCents    Int?                @map("llm_cost_cents")
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  stories         GlobalBriefingStory[]

  @@index([periodStart])
  @@index([status])
  @@map("global_briefings")
}

model GlobalBriefingStory {
  id              String          @id @default(uuid())
  briefingId      String          @map("briefing_id")
  rank            Int

  // Reddit Source Fields
  subreddit       String
  redditPostId    String          @map("reddit_post_id")
  redditPermalink String          @map("reddit_permalink")
  title           String
  postUrl         String?         @map("post_url")
  imageUrl        String?         @map("image_url")
  author          String?
  score           Int             @default(0)
  numComments     Int             @default(0) @map("num_comments")
  createdUtc      DateTime?       @map("created_utc")
  isSelfPost      Boolean         @default(false) @map("is_self_post")

  // LLM Outputs
  summary         String?
  sentimentLabel  String?         @map("sentiment_label")
  topicTags       Json?           @map("topic_tags")

  // Top comment
  topCommentAuthor  String?       @map("top_comment_author")
  topCommentBody    String?       @map("top_comment_body")
  topCommentScore   Int?          @map("top_comment_score")

  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  briefing        GlobalBriefing  @relation(fields: [briefingId], references: [id])

  @@unique([briefingId, rank])
  @@unique([briefingId, redditPostId])
  @@index([briefingId, rank])
  @@index([subreddit])
  @@index([redditPostId])
  @@map("global_briefing_stories")
}

// ============ API Health Tracking ============

model ApiStatus {
  id               String    @id @default("reddit")
  isHealthy        Boolean   @default(true) @map("is_healthy")
  lastCheckedAt    DateTime  @map("last_checked_at")
  lastHealthyAt    DateTime? @map("last_healthy_at")
  lastErrorCode    Int?      @map("last_error_code")
  lastErrorMessage String?   @map("last_error_message")
  failureCount     Int       @default(0) @map("failure_count")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  @@map("api_status")
}

// Reddit API request logging for rate limit tracking
model RedditApiLog {
  id        String   @id @default(uuid())
  endpoint  String
  status    Int      // HTTP status code
  createdAt DateTime @default(now()) @map("created_at")

  @@index([createdAt])
  @@map("reddit_api_logs")
}

// ============ Cron Job Management (Admin) ============

model CronJob {
  id              String      @id @default(uuid())
  name            String      @unique  // "global-briefing", "hourly-pulse", "daily-report"
  displayName     String      @map("display_name")
  description     String?
  script          String      // Path to job script relative to project root
  cronExpression  String      @map("cron_expression")
  enabled         Boolean     @default(true)
  lastRunAt       DateTime?   @map("last_run_at")
  lastRunStatus   JobStatus?  @map("last_run_status")
  lastRunDuration Int?        @map("last_run_duration")  // milliseconds
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  runHistory      CronJobRun[]

  @@map("cron_jobs")
}

model CronJobRun {
  id          String     @id @default(uuid())
  jobId       String     @map("job_id")
  startedAt   DateTime   @map("started_at")
  completedAt DateTime?  @map("completed_at")
  status      JobStatus
  output      String?    // Truncated stdout/stderr
  triggeredBy String     @map("triggered_by")  // "scheduled" | "manual:<username>"
  createdAt   DateTime   @default(now()) @map("created_at")

  job         CronJob    @relation(fields: [jobId], references: [id])

  @@index([jobId, startedAt(sort: Desc)])
  @@map("cron_job_runs")
}

enum JobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}
